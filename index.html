<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <title>textureUnpacker 2.1</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <meta name="author" content="Enea Entertainment" />
    <meta name="description" content="Texture atlas unpacker for TexturePacker files" />

    <link rel="shortcut icon" href="favicon.ico">

    <style type="text/css">
        /* ç°ä»£åŒ–æ ·å¼ */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .logo {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
        }

        h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 300;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-top: 10px;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #fafafa;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: #667eea;
            background-color: #f0f4ff;
        }

        .upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-toggle {
            background: #17a2b8;
            padding: 6px 12px;
            font-size: 14px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-checkbox {
            margin-right: 15px;
            width: 18px;
            height: 18px;
        }

        .file-info {
            flex-grow: 1;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .file-details {
            font-size: 0.9em;
            color: #666;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 15px 0;
            text-align: center;
        }

        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .hidden {
            display: none;
        }

        .progress-bar {
            height: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .results {
            margin-top: 20px;
        }

        .result-group {
            margin-bottom: 30px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fafafa;
        }

        .result-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            cursor: pointer;
            background-color: #e9ecef;
            border-radius: 8px 8px 0 0;
        }

        .result-group-title {
            margin: 0;
            color: #333;
            font-size: 1.2em;
        }

        .result-group-stats {
            font-size: 0.9em;
            color: #666;
            font-weight: normal;
        }

        .result-group-content {
            padding: 15px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .result-item {
            text-align: center;
        }

        .result-img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            background-color: white;
        }

        .result-name {
            font-size: 0.85em;
            margin-top: 5px;
            word-break: break-all;
        }

        .error-panel {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .error-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .error-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .error-item {
            padding: 8px 0;
            border-bottom: 1px solid #f5c6cb;
        }

        .error-item:last-child {
            border-bottom: none;
        }

        .error-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .error-message {
            font-family: monospace;
            font-size: 0.9em;
        }

        .failed-item {
            opacity: 0.5;
            position: relative;
        }

        .failed-item::after {
            content: "å¤„ç†å¤±è´¥";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.7);
            color: white;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .card {
                padding: 20px;
            }

            .btn-group {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 300px;
            }

            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>

    <script type="text/javascript" src="scripts/jszip.min.js"></script>
    <script type="text/javascript" src="scripts/filesaver.min.js"></script>
    <script type="text/javascript" src="scripts/pixi.min.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <img src="images/tu-logo.png" alt="textureUnpacker logo" class="logo" onerror="this.src='favicon.ico';">
            <h1>textureUnpacker 2.1</h1>
            <p class="subtitle">æ‰¹é‡è§£åŒ…TexturePackerå›¾é›†æ–‡ä»¶</p>
        </header>

        <main>
            <div class="card">
                <h2>é€‰æ‹©æ–‡ä»¶å¤¹</h2>
                <div class="upload-area" id="dropArea">
                    <div class="upload-icon">ğŸ“</div>
                    <p>æ‹–æ‹½æ–‡ä»¶å¤¹åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶å¤¹</p>
                    <p><small>æ”¯æŒ png / jpg å’Œ json / tpsheet æ–‡ä»¶å¯¹</small></p>
                    <input type="file" id="folderInput" webkitdirectory style="display: none;" multiple>
                    <button class="btn" id="selectFolderBtn">é€‰æ‹©æ–‡ä»¶å¤¹</button>
                </div>

                <div id="statusMessage" class="status hidden"></div>

                <div id="fileListContainer" class="file-list hidden">
                    <h3>å¯å¤„ç†çš„æ–‡ä»¶å¯¹</h3>
                    <div id="fileList"></div>
                    <div class="btn-group">
                        <button class="btn" id="selectAllBtn">å…¨é€‰</button>
                        <button class="btn" id="deselectAllBtn">å–æ¶ˆå…¨é€‰</button>
                        <button class="btn" id="processBtn" disabled>å¼€å§‹å¤„ç†</button>
                    </div>
                </div>

                <div id="processingSection" class="hidden">
                    <h3>å¤„ç†è¿›åº¦</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div id="progressText">å‡†å¤‡å¤„ç†...</div>
                </div>

                <div id="resultsSection" class="hidden">
                    <h3>å¤„ç†ç»“æœ</h3>
                    <div id="downloadProgress" class="status status-info hidden">
                        <div>æ­£åœ¨æ‰“åŒ…ä¸‹è½½æ–‡ä»¶ï¼Œè¯·ç¨å€™...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="downloadProgressFill" style="width: 0%"></div>
                        </div>
                        <div id="downloadProgressText">å‡†å¤‡ä¸­...</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn" id="downloadSelectedBtn">ä¸‹è½½é€‰ä¸­</button>
                        <button class="btn btn-secondary" id="downloadAllBtn">ä¸‹è½½å…¨éƒ¨</button>
                        <button class="btn btn-secondary" id="resetBtn">é‡æ–°å¼€å§‹</button>
                    </div>
                    <div id="resultsContainer" class="results"></div>
                </div>

                <div id="errorPanel" class="error-panel hidden">
                    <div class="error-header">
                        <h3>é”™è¯¯ä¿¡æ¯</h3>
                        <button class="btn btn-danger" id="clearErrorsBtn">æ¸…ç©ºé”™è¯¯</button>
                    </div>
                    <ul id="errorList" class="error-list"></ul>
                </div>
            </div>
        </main>

        <footer>
            <p>textureUnpacker 2.1 &copy; 2025 | è§£åŒ…TexturePackeråˆ›å»ºçš„å›¾é›†æ–‡ä»¶</p>
            <p>æ”¯æŒä¿®å‰ª(trimmed)å’Œæ—‹è½¬(rotated)çš„çº¹ç†</p>
        </footer>
    </div>

    <!-- éšè—å…ƒç´ ç”¨äºPIXIæ¸²æŸ“ -->
    <div id="sourceContent" style="display: none;"></div>
    <div id="destContent" style="display: none;"></div>

    <script type="text/javascript">
        // å…¨å±€å˜é‡
        let folderFiles = [];
        let matchedPairs = [];
        let processedResults = [];
        let currentPairIndex = 0;
        let renderer, stage;
        let errors = [];
        let currentFolderName = '';

        // DOMå…ƒç´ å¼•ç”¨
        const dropArea = document.getElementById('dropArea');
        const folderInput = document.getElementById('folderInput');
        const selectFolderBtn = document.getElementById('selectFolderBtn');
        const statusMessage = document.getElementById('statusMessage');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileList = document.getElementById('fileList');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const processBtn = document.getElementById('processBtn');
        const processingSection = document.getElementById('processingSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultsSection = document.getElementById('resultsSection');
        const resultsContainer = document.getElementById('resultsContainer');
        const downloadSelectedBtn = document.getElementById('downloadSelectedBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const resetBtn = document.getElementById('resetBtn');
        const errorPanel = document.getElementById('errorPanel');
        const errorList = document.getElementById('errorList');
        const clearErrorsBtn = document.getElementById('clearErrorsBtn');
        const downloadProgress = document.getElementById('downloadProgress');
        const downloadProgressFill = document.getElementById('downloadProgressFill');
        const downloadProgressText = document.getElementById('downloadProgressText');

        // åˆå§‹åŒ–åº”ç”¨
        window.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        function initializeApp() {
            // ç»‘å®šäº‹ä»¶
            selectFolderBtn.addEventListener('click', () => {
                folderInput.click();
            });

            folderInput.addEventListener('change', handleFolderSelect);

            // æ‹–æ‹½äº‹ä»¶
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('dragover');
            });

            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('dragover');
            });

            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('dragover');
                handleFolderDrop(e.dataTransfer);
            });

            // æŒ‰é’®äº‹ä»¶
            selectAllBtn.addEventListener('click', selectAllFiles);
            deselectAllBtn.addEventListener('click', deselectAllFiles);
            processBtn.addEventListener('click', processSelectedFiles);
            downloadSelectedBtn.addEventListener('click', downloadSelected);
            downloadAllBtn.addEventListener('click', downloadAll);
            resetBtn.addEventListener('click', resetApp);
            clearErrorsBtn.addEventListener('click', clearErrors);

            // åˆå§‹åŒ–PIXI
            initializePIXI();
        }

        function initializePIXI() {
            renderer = new PIXI.CanvasRenderer(100, 100, { transparent: true });
            renderer.view.style.display = 'none';
            document.getElementById('sourceContent').appendChild(renderer.view);
            stage = new PIXI.Container();
        }

        function handleFolderSelect(event) {
            const files = Array.from(event.target.files);
            // è·å–æ–‡ä»¶å¤¹åç§°
            if (files.length > 0) {
                const fullPath = files[0].webkitRelativePath;
                const folderName = fullPath.split('/')[0];
                currentFolderName = folderName;
            }
            processFolderFiles(files);
        }

        function handleFolderDrop(dataTransfer) {
            const files = Array.from(dataTransfer.items)
                .filter(item => item.webkitGetAsEntry().isFile)
                .map(item => item.getAsFile());
            // è·å–æ–‡ä»¶å¤¹åç§°
            if (files.length > 0) {
                const fullPath = files[0].webkitRelativePath;
                const folderName = fullPath.split('/')[0];
                currentFolderName = folderName;
            }
            processFolderFiles(files);
        }

        function processFolderFiles(files) {
            folderFiles = files;
            findMatchedPairs();
        }

        function findMatchedPairs() {
            // åˆ†ç¦»å›¾åƒå’Œé…ç½®æ–‡ä»¶ï¼ˆåŒ…æ‹¬JSONå’ŒTPSHEETï¼‰
            const imageFiles = folderFiles.filter(file => {
                const lowerName = file.name.toLowerCase();
                return lowerName.endsWith('.png') || lowerName.endsWith('.jpg') || lowerName.endsWith('.jpeg');
            });
            const jsonFiles = folderFiles.filter(file => file.name.toLowerCase().endsWith('.json'));
            const tpsheetFiles = folderFiles.filter(file => file.name.toLowerCase().endsWith('.tpsheet'));

            // åˆå¹¶é…ç½®æ–‡ä»¶åˆ—è¡¨
            const configFiles = [...jsonFiles, ...tpsheetFiles];

            // åŒ¹é…æ–‡ä»¶å¯¹
            matchedPairs = [];
            imageFiles.forEach(imageFile => {
                const imageName = imageFile.name.toLowerCase();
                let baseName;

                if (imageName.endsWith('.png')) {
                    baseName = imageFile.name.replace(/\.png$/i, '');
                } else if (imageName.endsWith('.jpg')) {
                    baseName = imageFile.name.replace(/\.jpg$/i, '');
                } else if (imageName.endsWith('.jpeg')) {
                    baseName = imageFile.name.replace(/\.jpeg$/i, '');
                }

                const matchingConfig = configFiles.find(configFile => {
                    const configBaseName = configFile.name
                        .replace(/\.json$/i, '')
                        .replace(/\.tpsheet$/i, '');
                    return configBaseName === baseName;
                });

                if (matchingConfig) {
                    matchedPairs.push({
                        name: baseName,
                        image: imageFile,
                        config: matchingConfig,
                        selected: true
                    });
                }
            });

            // æ˜¾ç¤ºç»“æœ
            showStatus(`æ‰¾åˆ° ${matchedPairs.length} å¯¹åŒ¹é…çš„æ–‡ä»¶`, 'status-success');
            displayFileList();
        }

        function displayFileList() {
            if (matchedPairs.length === 0) {
                fileList.innerHTML = '<p>æœªæ‰¾åˆ°åŒ¹é…çš„å›¾åƒ/é…ç½®æ–‡ä»¶å¯¹</p>';
                fileListContainer.classList.remove('hidden');
                processBtn.disabled = true;
                return;
            }

            let html = '';
            matchedPairs.forEach((pair, index) => {
                html += `
            <div class="file-item">
                <input type="checkbox" class="file-checkbox" id="file-${index}" 
                       data-index="${index}" ${pair.selected ? 'checked' : ''}>
                <div class="file-info">
                    <div class="file-name">${pair.name}</div>
                    <div class="file-details">
                        ${pair.image.name} + ${pair.config.name}
                    </div>
                </div>
            </div>
        `;
            });

            fileList.innerHTML = html;

            // ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    matchedPairs[index].selected = e.target.checked;
                    updateProcessButtonState();
                });
            });

            fileListContainer.classList.remove('hidden');
            updateProcessButtonState();
        }
        function updateProcessButtonState() {
            const selectedCount = matchedPairs.filter(pair => pair.selected).length;
            processBtn.disabled = selectedCount === 0;
        }

        function selectAllFiles() {
            matchedPairs.forEach(pair => pair.selected = true);
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateProcessButtonState();
        }

        function deselectAllFiles() {
            matchedPairs.forEach(pair => pair.selected = false);
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateProcessButtonState();
        }

        async function processSelectedFiles() {
            const selectedPairs = matchedPairs.filter(pair => pair.selected);
            if (selectedPairs.length === 0) return;

            // æ˜¾ç¤ºå¤„ç†åŒºåŸŸ
            processingSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            fileListContainer.classList.add('hidden');
            progressFill.style.width = '0%';
            progressText.textContent = 'å‡†å¤‡å¤„ç†...';

            processedResults = [];
            currentPairIndex = 0;

            // é€ä¸ªå¤„ç†é€‰ä¸­çš„æ–‡ä»¶å¯¹
            for (const pair of selectedPairs) {
                try {
                    await processSinglePair(pair);
                    currentPairIndex++;
                    const progress = (currentPairIndex / selectedPairs.length) * 100;
                    progressFill.style.width = progress + '%';
                    progressText.textContent = `æ­£åœ¨å¤„ç†: ${pair.name} (${currentPairIndex}/${selectedPairs.length})`;
                } catch (error) {
                    console.error('å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™:', error);
                    addError(`å¤„ç† ${pair.name} æ—¶å‡ºé”™`, error.message);
                    progressText.textContent = `å¤„ç† ${pair.name} æ—¶å‡ºé”™: ${error.message}`;
                }
            }

            // æ˜¾ç¤ºç»“æœ
            showResults();
        }

        function processSinglePair(pair) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                // è¯»å–é…ç½®æ–‡ä»¶
                reader.onload = (e) => {
                    try {
                        let jsonData;

                        // åˆ¤æ–­é…ç½®æ–‡ä»¶ç±»å‹
                        if (pair.config.name.toLowerCase().endsWith('.tpsheet')) {
                            // è§£æ.tpsheetæ ¼å¼ä¸ºJSONæ ¼å¼
                            jsonData = parseTpsheetToJson(e.target.result);
                        } else {
                            // JSONæ–‡ä»¶ç›´æ¥è§£æ
                            jsonData = JSON.parse(e.target.result);
                        }

                        // è¯»å–å›¾åƒæ–‡ä»¶
                        const imageReader = new FileReader();
                        imageReader.onload = (event) => {
                            try {
                                // ä½¿ç”¨PIXIå¤„ç†
                                processWithPIXI(event.target.result, jsonData, pair.name)
                                    .then(result => {
                                        processedResults.push({
                                            name: pair.name,
                                            images: result,
                                            failedCount: 0 // åˆå§‹åŒ–å¤±è´¥è®¡æ•°
                                        });
                                        resolve();
                                    })
                                    .catch(error => {
                                        // è®°å½•Spritesheetåˆ›å»ºå¤±è´¥çš„é”™è¯¯
                                        addError(`å¤„ç† ${pair.name} æ—¶å‡ºé”™`, error.message);
                                        processedResults.push({
                                            name: pair.name,
                                            images: [],
                                            failedCount: 1 // æ ‡è®°ä¸ºå¤±è´¥
                                        });
                                        resolve();
                                    });
                            } catch (error) {
                                reject(error);
                            }
                        };
                        imageReader.onerror = reject;
                        imageReader.readAsDataURL(pair.image);
                    } catch (error) {
                        reject(error);
                    }
                };

                reader.onerror = reject;
                reader.readAsText(pair.config);
            });
        }

        function processWithPIXI(pngData, jsonData, pairName) {
            return new Promise((resolve, reject) => {
                // é‡ç½®loaderå¹¶ä½¿ç”¨æ­£ç¡®çš„PIXI.loader API (å°å†™l)
                PIXI.loader.reset();
                PIXI.loader
                    .add(pairName, pngData)
                    .load((loader, resources) => {
                        try {
                            const resource = resources[pairName];
                            if (!resource || !resource.texture || !resource.texture.baseTexture) {
                                resolve([]);
                                return;
                            }

                            // ç­‰å¾…åŸºç¡€çº¹ç†åŠ è½½å®Œæˆåå†åˆ›å»ºSpritesheet
                            const baseTexture = resource.texture.baseTexture;

                            // ç¡®ä¿åŸºç¡€çº¹ç†å·²åŠ è½½å¹¶å…·æœ‰æ­£ç¡®çš„å°ºå¯¸
                            if (!baseTexture.hasLoaded) {
                                baseTexture.once('loaded', () => {
                                    createSpriteSheetAndParse(baseTexture, jsonData, pairName, resolve, reject);
                                });
                            } else {
                                createSpriteSheetAndParse(baseTexture, jsonData, pairName, resolve, reject);
                            }
                        } catch (error) {
                            console.error('PIXIå¤„ç†é”™è¯¯:', error);
                            reject(error); // æ‹’ç»Promiseä»¥ä¾¿ä¸Šå±‚å¯ä»¥æ•è·
                        }
                    });
            });
        }

        function createSpriteSheetAndParse(baseTexture, jsonData, pairName, resolve, reject) {
            try {
                // åˆ›å»ºSpritesheetå¹¶è§£æ
                const spritesheet = new PIXI.Spritesheet(baseTexture, jsonData, pairName);

                spritesheet.parse((textures) => {
                    const images = [];
                    let failedCount = 0;

                    // éå†æ‰€æœ‰çº¹ç†
                    const textureNames = Object.keys(textures);
                    let processedCount = 0;

                    // å¦‚æœæ²¡æœ‰çº¹ç†ï¼Œç›´æ¥resolve
                    if (textureNames.length === 0) {
                        resolve(images);
                        return;
                    }

                    textureNames.forEach(textureName => {
                        try {
                            const texture = textures[textureName];
                            const sprite = new PIXI.Sprite(texture);

                            // åˆ›å»ºä¸´æ—¶èˆå°
                            const tempStage = new PIXI.Container();
                            tempStage.addChild(sprite);

                            // åˆ›å»ºç”»å¸ƒå¹¶æ¸²æŸ“
                            const canvas = document.createElement('canvas');
                            canvas.width = sprite.width;
                            canvas.height = sprite.height;

                            // è°ƒæ•´æ¸²æŸ“å™¨å¤§å°å¹¶æ¸²æŸ“
                            renderer.resize(sprite.width, sprite.height);
                            renderer.render(tempStage);

                            // ç»˜åˆ¶åˆ°ç”»å¸ƒ
                            const context = canvas.getContext('2d');
                            context.drawImage(renderer.view, 0, 0);

                            images.push({
                                name: textureName,
                                dataUrl: canvas.toDataURL(),
                                width: sprite.width,
                                height: sprite.height
                            });

                            // æ¸…ç†
                            tempStage.removeChild(sprite);
                        } catch (textureError) {
                            console.warn(`å¤„ç†çº¹ç† ${textureName} æ—¶å‡ºé”™:`, textureError);
                            failedCount++;
                            addError(`å¤„ç† ${pairName} ä¸­çš„ ${textureName} æ—¶å‡ºé”™`, textureError.message);
                        } finally {
                            processedCount++;
                            // å½“æ‰€æœ‰çº¹ç†éƒ½å¤„ç†å®Œæ¯•æ—¶ï¼Œresolve promise
                            if (processedCount === textureNames.length) {
                                // æ›´æ–°å¤±è´¥è®¡æ•°
                                const resultEntry = processedResults.find(r => r.name === pairName);
                                if (resultEntry) {
                                    resultEntry.failedCount = failedCount;
                                }
                                resolve(images);
                            }
                        }
                    });
                });
            } catch (sheetError) {
                console.error('Spritesheetåˆ›å»ºé”™è¯¯:', sheetError);
                reject(sheetError); // æ‹’ç»Promiseä»¥ä¾¿ä¸Šå±‚å¯ä»¥æ•è·
            }
        }

        function showResults() {
            processingSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');

            let totalImages = 0;
            let totalFailed = 0;

            let html = '';
            processedResults.forEach((result, index) => {
                totalImages += result.images.length;
                totalFailed += result.failedCount || 0;

                // ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºä¸€ä¸ªåˆ†ç»„å®¹å™¨
                html += `
            <div class="result-group" data-group-name="${result.name}" data-group-index="${index}">
                <div class="result-group-header">
                    <h3 class="result-group-title">${result.name} <span class="result-group-stats">(${result.images.length} å¼ å›¾ç‰‡${result.failedCount ? ', ' + result.failedCount + ' å¼ å¤±è´¥' : ''})</span></h3>
                    <button class="btn btn-toggle btn-expand" data-target="${result.name}" data-index="${index}">å±•å¼€</button>
                </div>
                <div class="result-group-content hidden" id="group-content-${result.name}-${index}">
                    <div class="results-grid">
        `;

                // æ˜¾ç¤ºæˆåŠŸçš„å›¾ç‰‡
                result.images.forEach(image => {
                    html += `
                <div class="result-item">
                    <img src="${image.dataUrl}" alt="${image.name}" 
                         class="result-img" title="${image.name} (${image.width}x${image.height})">
                    <div class="result-name" title="${image.name}">${getShortName(image.name, 15)}</div>
                </div>
            `;
                });

                // æ˜¾ç¤ºå¤±è´¥çš„é¡¹ç›®
                for (let i = 0; i < (result.failedCount || 0); i++) {
                    html += `
                <div class="result-item failed-item">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23ccc'/%3E%3Cline x1='0' y1='0' x2='100' y2='100' stroke='%23f00' stroke-width='2'/%3E%3C/svg%3E" 
                         alt="å¤„ç†å¤±è´¥" class="result-img">
                    <div class="result-name">å¤„ç†å¤±è´¥</div>
                </div>
            `;
                }

                html += `
                    </div>
                </div>
            </div>
        `;
            });

            resultsContainer.innerHTML = html;

            // ç»‘å®šæŠ˜å /å±•å¼€äº‹ä»¶
            document.querySelectorAll('.result-group-header').forEach(header => {
                header.addEventListener('click', function (e) {
                    if (e.target.classList.contains('btn-toggle')) return;
                    const groupName = this.closest('.result-group').dataset.groupName;
                    const groupIndex = this.closest('.result-group').dataset.groupIndex;
                    toggleGroup(groupName, groupIndex);
                });
            });

            document.querySelectorAll('.btn-toggle').forEach(button => {
                button.addEventListener('click', function () {
                    const groupName = this.dataset.target;
                    const groupIndex = this.dataset.index;
                    toggleGroup(groupName, groupIndex);
                });
            });

            // æ˜¾ç¤ºå¤„ç†ç»“æœçŠ¶æ€
            if (totalFailed > 0) {
                showStatus(`å¤„ç†å®Œæˆ: å…±${totalImages + totalFailed}å¼ å›¾ç‰‡ï¼Œ${totalFailed}å¼ å¤„ç†å¤±è´¥`, 'status-warning');
            } else {
                showStatus(`å¤„ç†å®Œæˆ: å…±${totalImages}å¼ å›¾ç‰‡`, 'status-success');
            }
        }

        function toggleGroup(groupName, groupIndex) {
            const content = document.getElementById(`group-content-${groupName}-${groupIndex}`);
            const button = document.querySelector(`.btn-toggle[data-target="${groupName}"][data-index="${groupIndex}"]`);

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                button.textContent = 'æ”¶èµ·';
                button.classList.remove('btn-expand');
            } else {
                content.classList.add('hidden');
                button.textContent = 'å±•å¼€';
                button.classList.add('btn-expand');
            }
        }

        function getShortName(name, maxLength) {
            if (name.length <= maxLength) return name;
            return name.substring(0, maxLength) + '...';
        }

        function downloadSelected() {
            // å½“å‰ç‰ˆæœ¬ä¸­ï¼Œ"ä¸‹è½½é€‰ä¸­"æŒ‰é’®å’Œ"ä¸‹è½½å…¨éƒ¨"æŒ‰é’®åŠŸèƒ½ç›¸åŒ
            // å› ä¸ºé¢„è§ˆé¡µé¢ä¸­çš„å›¾ç‰‡ç›®å‰ä¸æ”¯æŒå•ç‹¬é€‰æ‹©
            downloadAll();
        }

        function downloadAll() {
            if (processedResults.length === 0) return;

            // æ˜¾ç¤ºä¸‹è½½è¿›åº¦
            downloadProgress.classList.remove('hidden');
            downloadProgressFill.style.width = '0%';
            downloadProgressText.textContent = 'å‡†å¤‡æ‰“åŒ…æ–‡ä»¶...';

            const zip = new JSZip();
            let totalFiles = 0;
            let currentFile = 0;

            // è®¡ç®—æ€»æ–‡ä»¶æ•°
            processedResults.forEach(result => {
                totalFiles += result.images.length;
            });

            // æ›´æ–°è¿›åº¦æ˜¾ç¤º
            function updateProgress() {
                currentFile++;
                const progress = (currentFile / totalFiles) * 100;
                downloadProgressFill.style.width = progress + '%';
                downloadProgressText.textContent = `æ­£åœ¨æ‰“åŒ…: ${currentFile}/${totalFiles} æ–‡ä»¶`;
            }

            // æ·»åŠ æ–‡ä»¶åˆ°ZIP
            processedResults.forEach(result => {
                const folder = zip.folder(result.name);
                result.images.forEach(image => {
                    const data = image.dataUrl.split(',')[1];
                    folder.file(`${image.name}.png`, data, { base64: true });
                    // ä½¿ç”¨setTimeoutç¡®ä¿è¿›åº¦æ›´æ–°ä¸ä¼šè¢«é˜»å¡
                    setTimeout(updateProgress, 0);
                });
            });

            // ç”Ÿæˆå¹¶ä¸‹è½½ZIP
            zip.generateAsync({ type: 'blob' }, (metadata) => {
                // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                const percent = metadata.percent.toFixed(1);
                downloadProgressText.textContent = `æ­£åœ¨ç”ŸæˆZIPæ–‡ä»¶: ${percent}%`;
                downloadProgressFill.style.width = percent + '%';
            }).then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                // ä½¿ç”¨æ–‡ä»¶å¤¹åç§°ä½œä¸ºæ–‡ä»¶åï¼Œå¦‚æœä¸å¯ç”¨åˆ™å›é€€åˆ°åŸæ¥çš„æ–¹å¼
                const zipFileName = currentFolderName || (processedResults.length > 0 ? processedResults[0].name : 'texture_unpack_result');
                a.download = `${zipFileName}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // éšè—è¿›åº¦æ˜¾ç¤º
                setTimeout(() => {
                    downloadProgress.classList.add('hidden');
                }, 1000);
            }).catch(error => {
                console.error('ZIPç”Ÿæˆé”™è¯¯:', error);
                showStatus('ä¸‹è½½è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯', 'status-error');
                downloadProgress.classList.add('hidden');
            });
        }

        function showStatus(message, className) {
            statusMessage.textContent = message;
            statusMessage.className = 'status ' + className;
            statusMessage.classList.remove('hidden');

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }

        /**
         * å°†.tpsheetæ ¼å¼è§£æä¸ºJSONæ ¼å¼
         * @param {string} tpsheetContent - .tpsheetæ–‡ä»¶å†…å®¹
         * @returns {object} è§£æåçš„JSONå¯¹è±¡
         */
        function parseTpsheetToJson(tpsheetContent) {
            const lines = tpsheetContent.split('\n');
            const meta = {};
            const frames = {};

            let textureWidth = 0;
            let textureHeight = 0;

            // è§£æå…ƒæ•°æ®è¡Œï¼ˆä»¥å†’å·å¼€å¤´çš„è¡Œï¼‰
            lines.forEach(line => {
                line = line.trim();
                if (!line || line.startsWith('#')) return; // å¿½ç•¥ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ

                if (line.startsWith(':')) {
                    // å…ƒæ•°æ®è¡Œï¼Œä¾‹å¦‚ :format=40300
                    const [key, value] = line.substring(1).split('=');
                    meta[key] = value;

                    // è·å–çº¹ç†å°ºå¯¸
                    if (key === 'size') {
                        const [w, h] = value.split('x');
                        textureWidth = parseInt(w);
                        textureHeight = parseInt(h);
                    }
                }
            });

            // è§£æå¸§æ•°æ®è¡Œ
            lines.forEach(line => {
                line = line.trim();
                if (!line || line.startsWith('#') || line.startsWith(':')) return;

                // å¸§æ•°æ®è¡Œï¼Œä¾‹å¦‚ theme10414_i_1;2;5;128;113; 0.5;0.4513274336283186; 0;0;0;0; 4;128;0;0;0;0;113;128;113; 2;1;2;3;0;1;3
                const parts = line.split(';');
                if (parts.length < 5) return; // ä¸æ˜¯æœ‰æ•ˆçš„å¸§æ•°æ®

                const name = parts[0];
                const x = parseInt(parts[1]);
                let y = parseInt(parts[2]); // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ç‰¹æ®Šå¤„ç†
                const w = parseInt(parts[3]);
                const h = parseInt(parts[4]);

                // åœ¨Unityä¸­ï¼ŒYè½´æ˜¯ä»ä¸‹å¾€ä¸Šè®¡ç®—çš„ï¼Œè€ŒWebä¸­æ˜¯ä»ä¸Šå¾€ä¸‹è®¡ç®—çš„
                // æ‰€ä»¥éœ€è¦è½¬æ¢Yåæ ‡
                y = textureHeight - y - h;

                // pivotç‚¹ä¿¡æ¯
                let pivotX = 0.5;
                let pivotY = 0.5;
                if (parts.length > 6) {
                    pivotX = parseFloat(parts[5]);
                    // Unityä¸­çš„pivot Yåæ ‡ä¹Ÿéœ€è¦ç¿»è½¬
                    pivotY = 1.0 - parseFloat(parts[6]);
                }

                // åˆ›å»ºæ ‡å‡†PIXI.jsæ ¼å¼çš„frameå¯¹è±¡
                frames[name] = {
                    frame: {
                        x: x,
                        y: y,
                        w: w,
                        h: h
                    },
                    rotated: false,
                    trimmed: false,
                    spriteSourceSize: {
                        x: 0,
                        y: 0,
                        w: w,
                        h: h
                    },
                    sourceSize: {
                        w: w,
                        h: h
                    },
                    pivot: {
                        x: pivotX,
                        y: pivotY
                    }
                };
            });

            // æ„å»ºç¬¦åˆPIXI.js Spritesheetæ ¼å¼çš„JSONå¯¹è±¡
            const result = {
                frames: frames,
                meta: meta
            };

            return result;
        }

        function addError(title, message) {
            errors.push({
                title: title,
                message: message,
                timestamp: new Date()
            });

            displayErrors();
        }

        function displayErrors() {
            if (errors.length === 0) {
                errorPanel.classList.add('hidden');
                return;
            }

            let html = '';
            errors.forEach(error => {
                html += `
                    <li class="error-item">
                        <div class="error-title">${error.title}</div>
                        <div class="error-message">${error.message}</div>
                    </li>
                `;
            });

            errorList.innerHTML = html;
            errorPanel.classList.remove('hidden');
        }

        function clearErrors() {
            errors = [];
            displayErrors();
        }

        function resetApp() {
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            folderFiles = [];
            matchedPairs = [];
            processedResults = [];
            errors = [];

            // æ¸…ç©ºè¾“å…¥
            folderInput.value = '';

            // éšè—æ‰€æœ‰éƒ¨åˆ†
            fileListContainer.classList.add('hidden');
            processingSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            statusMessage.classList.add('hidden');
            errorPanel.classList.add('hidden');
            downloadProgress.classList.add('hidden');

            // é‡ç½®è¿›åº¦æ¡
            progressFill.style.width = '0%';
            downloadProgressFill.style.width = '0%';
        }
    </script>
</body>

</html>